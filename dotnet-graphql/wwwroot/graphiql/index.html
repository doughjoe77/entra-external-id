<!DOCTYPE html>
<html>
<head>
    <title>GraphiQL + MSAL Auto Login</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/graphiql@3.0.0/graphiql.min.css" />

    <style>
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: sans-serif;
        }

        /* Header styling */
        .app-header {
            height: 50px;
            background: #1e1e1e;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            box-sizing: border-box;
        }

        .header-title {
            font-size: 18px;
            font-weight: 600;
        }

        .logout-button {
            background: #e74c3c;
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

            .logout-button:hover {
                background: #c0392b;
            }

        #graphiql {
            height: calc(100vh - 50px);
        }
    </style>

    <!-- Load your dynamic config -->
    <script src="./config.js"></script>
</head>

<body>

    <!-- Header -->
    <header class="app-header">
        <div class="header-title">GraphQL Explorer</div>
        <button id="logoutBtn" class="logout-button">Logout</button>
    </header>

    <!-- GraphiQL container -->
    <div id="graphiql">Loading…</div>

    <!-- React -->
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- GraphiQL -->
    <script src="https://cdn.jsdelivr.net/npm/graphiql@3.0.0/graphiql.min.js"></script>

    <!-- MSAL -->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

    <script>
        // -------------------------------------------------------
        // MSAL configuration from dynamic config.js
        // -------------------------------------------------------
        const msalConfig = {
            auth: {
                clientId: window.appConfig.clientId,
                authority: window.appConfig.authority,
                redirectUri: window.appConfig.redirectUri
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: false
            }
        };

        const msalInstance = new msal.PublicClientApplication(msalConfig);

        const tokenRequest = {
            scopes: [window.appConfig.apiScope]
        };

        let accessToken = null;

        // -------------------------------------------------------
        // Rolling inactivity logout
        // -------------------------------------------------------
        let logoutTimer = null;

        function startAutoLogout() {
            const minutes = parseInt(window.appConfig.logoutMinutes, 10);
            const ms = minutes * 60 * 1000;

            if (logoutTimer) {
                clearTimeout(logoutTimer);
            }

            logoutTimer = setTimeout(() => {
                console.log("Auto-logout triggered after inactivity.");

                msalInstance.logoutRedirect({
                    postLogoutRedirectUri: window.location.origin + "/logout.html"
                });
            }, ms);
        }

        function enableActivityReset() {
            const resetEvents = ["click", "keydown", "mousemove", "scroll"];

            resetEvents.forEach(evt => {
                document.addEventListener(evt, () => startAutoLogout());
            });
        }

        // -------------------------------------------------------
        // Manual Logout Button
        // -------------------------------------------------------
        document.getElementById("logoutBtn").onclick = () => {
            const account = msalInstance.getActiveAccount();

            msalInstance.logoutRedirect({
                account,
                postLogoutRedirectUri: window.location.origin + "/graphiql/logout.html"
            });
        };

        // -------------------------------------------------------
        // Handle MSAL redirect login
        // -------------------------------------------------------
        msalInstance.handleRedirectPromise().then(async (result) => {

            if (result && result.accessToken) {
                accessToken = result.accessToken;
                startAutoLogout();
                enableActivityReset();
                startGraphiQL();
                return;
            }

            const accounts = msalInstance.getAllAccounts();

            if (accounts.length === 0) {
                msalInstance.loginRedirect(tokenRequest);
                return;
            }

            try {
                const silent = await msalInstance.acquireTokenSilent({
                    ...tokenRequest,
                    account: accounts[0]
                });

                accessToken = silent.accessToken;
                startAutoLogout();
                enableActivityReset();
                startGraphiQL();
            }
            catch (err) {
                msalInstance.loginRedirect(tokenRequest);
            }
        });

        // -------------------------------------------------------
        // GraphQL fetcher + GraphiQL initialization
        // -------------------------------------------------------
        function startGraphiQL() {

            const graphQLFetcher = async (graphQLParams, fetcherOpts) => {
                const headers = {
                    "Content-Type": "application/json",
                    ...fetcherOpts?.headers
                };

                const response = await fetch("/graphql", {
                    method: "POST",
                    headers,
                    body: JSON.stringify(graphQLParams)
                });

                return response.json();
            };

            const defaultHeaders = {
                "Authorization": "Bearer " + accessToken
            };

            ReactDOM.render(
                React.createElement(GraphiQL, {
                    fetcher: graphQLFetcher,
                    headerEditorEnabled: true,
                    defaultHeaders: JSON.stringify(defaultHeaders, null, 2)
                }),
                document.getElementById("graphiql")
            );
        }
    </script>
</body>
</html>
